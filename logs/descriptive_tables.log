-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/logs/descriptive_tables.log
  log type:  text
 opened on:  30 Oct 2024, 20:57:23

. 
. **Set Ado file path
. adopath + "$projectdir/analysis/extra_ados"
  [1]  (BASE)      "/usr/local/stata/ado/base/"
  [2]  (SITE)      "/usr/local/ado/"
  [3]              "."
  [4]  (PERSONAL)  "~/ado/personal/"
  [5]  (PLUS)      "~/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/workspace/analysis/extra_ados"

. 
. **Use cleaned data from previous step
. import delimited "$projectdir/output/measures/measures_dataset.csv", clear
(10 vars, 9,070 obs)

. 
. set scheme plotplainblind

. 
. *Descriptive statistics======================================================
> ================*/
. 
. rename interval_start interval_start_s

. gen interval_start = date(interval_start_s, "YMD") 

. format interval_start %td

. drop interval_start_s interval_end

. 
. **Month/Year of interval
. gen year_diag=year(interval_start)

. format year_diag %ty

. gen month_diag=month(interval_start)

. gen mo_year_diagn=ym(year_diag, month_diag)

. format mo_year_diagn %tmMon-CCYY

. generate str16 mo_year_diagn_s = strofreal(mo_year_diagn,"%tmCCYY!mNN")

. lab var mo_year_diagn "Month/Year of Diagnosis"

. lab var mo_year_diagn_s "Month/Year of Diagnosis"

. 
. gen ratio_100000 = ratio*100000

. 
. gen measure_inc = 1 if substr(measure,-10,.) == "_incidence"
(3,886 missing values generated)

. recode measure_inc .=0
(measure_inc: 3886 changes made)

. gen measure_prev = 1 if substr(measure,-11,.) == "_prevalence"
(8,638 missing values generated)

. recode measure_prev .=0
(measure_prev: 8638 changes made)

. gen measure_imd = 1 if substr(measure,-4,.) == "_imd"
(7,342 missing values generated)

. recode measure_imd .=0
(measure_imd: 7342 changes made)

. gen measure_ethnicity = 1 if substr(measure,-10,.) == "_ethnicity"
(7,344 missing values generated)

. recode measure_ethnicity .=0
(measure_ethnicity: 7344 changes made)

. 
. gen measure_inc_any = 1 if measure_inc ==1 | measure_imd==1 | measure_ethnici
> ty==1
(432 missing values generated)

. recode measure_inc_any .=0
(measure_inc_any: 432 changes made)

. 
. gen diseases_ = substr(measure, 1, strlen(measure) - 10) if measure_inc==1
(3,886 missing values generated)

. replace diseases_ = substr(measure, 1, strlen(measure) - 11) if measure_prev=
> =1
(432 real changes made)

. replace diseases_ = substr(measure, 1, strlen(measure) - 14) if measure_imd==
> 1
(1,728 real changes made)

. replace diseases_ = substr(measure, 1, strlen(measure) - 20) if measure_ethni
> city==1
(1,726 real changes made)

. gen disease = strproper(subinstr(diseases_, "_", " ",.)) 

. 
. *Generate incidence and prevalence by months across ages, sexes, IMD and ethn
> icity
. sort disease mo_year_diagn measure

. bys disease mo_year_diagn measure: egen numerator_all = sum(numerator)

. bys disease mo_year_diagn measure: egen denominator_all = sum(denominator)

. gen ratio_all = numerator_all/denominator_all

. gen ratio_all_100000 = ratio_all*100000

. 
. bys disease mo_year_diagn measure: egen numerator_male = sum(numerator) if se
> x=="male"
(6262 missing values generated)

. bys disease mo_year_diagn measure: egen denominator_male = sum(denominator) i
> f sex=="male"
(6262 missing values generated)

. gen ratio_male = numerator_male/denominator_male
(6,262 missing values generated)

. gen ratio_male_100000 = ratio_male*100000
(6,262 missing values generated)

. sort disease mo_year_diagn measure_prev measure_inc_any ratio_male_100000 

. by disease mo_year_diagn measure_prev measure_inc_any (ratio_male_100000): re
> place ratio_male_100000 = ratio_male_100000[_n-1] if missing(ratio_male_10000
> 0)
(6262 real changes made)

. 
. bys disease mo_year_diagn measure: egen numerator_female = sum(numerator) if 
> sex=="female"
(6262 missing values generated)

. bys disease mo_year_diagn measure: egen denominator_female = sum(denominator)
>  if sex=="female"
(6262 missing values generated)

. gen ratio_female = numerator_female/denominator_female
(6,262 missing values generated)

. gen ratio_female_100000 = ratio_female*100000
(6,262 missing values generated)

. sort disease mo_year_diagn measure_prev measure_inc_any ratio_female_100000 

. by disease mo_year_diagn measure_prev measure_inc_any (ratio_female_100000): 
> replace ratio_female_100000 = ratio_female_100000[_n-1] if missing(ratio_fema
> le_100000)
(6262 real changes made)

. 
. **DO the same for IMD and ethnicity, then add moving average
. 
. save "$projectdir/output/data/processed_nonstandardised.dta", replace
file /workspace/output/data/processed_nonstandardised.dta saved

. 
. *Export a CSV for import into ARIMA R file
. keep if measure_inc==1
(3,886 observations deleted)

. sort disease mo_year_diagn age sex

. bys measure interval_start: gen n=_n

. keep if n==1
(4,896 observations deleted)

. drop n

. 
. rename year_diag year

. rename ratio_all_100000 incidence

. replace sex = "All"
(288 real changes made)

. keep disease sex mo_year_diagn year numerator_all denominator_all incidence

. rename numerator_all numerator

. rename denominator_all denominator

. 
. save "$projectdir/output/data/arima_nonstandardised.dta", replace //change to
>  remove _new when ready
file /workspace/output/data/arima_nonstandardised.dta saved

. outsheet * using "$projectdir/output/data/arima_nonstandardised.csv" , comma 
> replace //change to remove _new when ready 
(note: file /workspace/output/data/arima_nonstandardised.csv not found)

. 
. *Calculate the age-standardized incidence rate (ASIR): use age specific incid
> ence data - European Standard Population 2013
. import excel "$projectdir/output/data/ESP.xls", sheet("Sheet1") firstrow clea
> r
(3 vars, 10 obs)

. drop if age=="All"
(1 observation deleted)

. save "$projectdir/output/data/esp_for_standardisation.dta", replace
file /workspace/output/data/esp_for_standardisation.dta saved

. 
. * Apply the Standard Population Weights: multiply crude age-specific incidenc
> e rates by corresponding standard population weights
. use "$projectdir/output/data/processed_nonstandardised.dta", clear

. merge m:1 age using "$projectdir/output/data/esp_for_standardisation.dta", no
> gen

    Result                           # of obs.
    -----------------------------------------
    not matched                         3,454
        from master                     3,454  
        from using                          0  

    matched                             5,616  
    -----------------------------------------

. 
. *Generate standardised incidence and prevalence, overall and by sex
. gen new_value = prop*ratio_100000
(3,454 missing values generated)

. bys disease mo_year_diagn measure: egen sum_new_value_male=sum(new_value) if 
> sex=="male" 
(6262 missing values generated)

. gen asr_male = sum_new_value_male/100000
(6,262 missing values generated)

. sort disease mo_year_diagn measure asr_male 

. by disease mo_year_diagn measure (asr_male): replace asr_male = asr_male[_n-1
> ] if missing(asr_male)
(2808 real changes made)

. bys disease mo_year_diagn measure: egen sum_new_value_female=sum(new_value) i
> f sex=="female" 
(6262 missing values generated)

. gen asr_female = sum_new_value_female/100000
(6,262 missing values generated)

. sort disease mo_year_diagn measure asr_female 

. by disease mo_year_diagn measure (asr_female): replace asr_female = asr_femal
> e[_n-1] if missing(asr_female)
(2808 real changes made)

. bys disease mo_year_diagn measure: egen sum_new_value_all=sum(new_value)

. gen asr_all = sum_new_value_all/200000

. 
. *Generate standardised incidence and prevalence, by age group - need to doubl
> e check this
. bys disease mo_year_diagn measure: egen sum_new_value_0_9=sum(new_value) if a
> ge=="age_0_9"
(8446 missing values generated)

. gen asr_0_9 = sum_new_value_0_9/21000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_0_9 

. by disease mo_year_diagn measure (asr_0_9): replace asr_0_9 = asr_0_9[_n-1] i
> f missing(asr_0_9)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_10_19=sum(new_value) if
>  age=="age_10_19"
(8446 missing values generated)

. gen asr_10_19 = sum_new_value_10_19/22000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_10_19 

. by disease mo_year_diagn measure (asr_10_19): replace asr_10_19 = asr_10_19[_
> n-1] if missing(asr_10_19)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_20_29=sum(new_value) if
>  age=="age_20_29"
(8446 missing values generated)

. gen asr_20_29 = sum_new_value_20_29/24000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_20_29 

. by disease mo_year_diagn measure (asr_20_29): replace asr_20_29 = asr_20_29[_
> n-1] if missing(asr_20_29)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_30_39=sum(new_value) if
>  age=="age_30_39"
(8446 missing values generated)

. gen asr_30_39 = sum_new_value_30_39/27000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_30_39 

. by disease mo_year_diagn measure (asr_30_39): replace asr_30_39 = asr_30_39[_
> n-1] if missing(asr_30_39)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_40_49=sum(new_value) if
>  age=="age_40_49"
(8446 missing values generated)

. gen asr_40_49 = sum_new_value_40_49/28000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_40_49 

. by disease mo_year_diagn measure (asr_40_49): replace asr_40_49 = asr_40_49[_
> n-1] if missing(asr_40_49)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_50_59=sum(new_value) if
>  age=="age_50_59"
(8446 missing values generated)

. gen asr_50_59 = sum_new_value_50_59/27000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_50_59 

. by disease mo_year_diagn measure (asr_50_59): replace asr_50_59 = asr_50_59[_
> n-1] if missing(asr_50_59)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_60_69=sum(new_value) if
>  age=="age_60_69"
(8446 missing values generated)

. gen asr_60_69 = sum_new_value_60_69/23000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_60_69 

. by disease mo_year_diagn measure (asr_60_69): replace asr_60_69 = asr_60_69[_
> n-1] if missing(asr_60_69)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_70_79=sum(new_value) if
>  age=="age_70_79"
(8446 missing values generated)

. gen asr_70_79 = sum_new_value_70_79/18000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_70_79 

. by disease mo_year_diagn measure (asr_70_79): replace asr_70_79 = asr_70_79[_
> n-1] if missing(asr_70_79)
(4992 real changes made)

. 
. bys disease mo_year_diagn measure: egen sum_new_value_80=sum(new_value) if ag
> e=="age_greater_equal_80"
(8446 missing values generated)

. gen asr_80 = sum_new_value_80/10000
(8,446 missing values generated)

. sort disease mo_year_diagn measure asr_80 

. by disease mo_year_diagn measure (asr_80): replace asr_80 = asr_80[_n-1] if m
> issing(asr_80)
(4992 real changes made)

. 
. sort disease mo_year_diagn measure age sex

. bys measure interval_start: gen n=_n

. keep if n==1
(8,182 observations deleted)

. drop n

. 
. *Generate 3-monthly moving averages of asr
. bysort measure (interval_start): gen asr_all_ma =(asr_all[_n-1]+asr_all[_n]+a
> sr_all[_n+1])/3
(24 missing values generated)

. bysort measure (interval_start): gen asr_male_ma =(asr_male[_n-1]+asr_male[_n
> ]+asr_male[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_female_ma =(asr_female[_n-1]+asr_fem
> ale[_n]+asr_female[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_0_9_ma =(asr_0_9[_n-1]+asr_0_9[_n]+a
> sr_0_9[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_10_19_ma =(asr_10_19[_n-1]+asr_10_19
> [_n]+asr_10_19[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_20_29_ma =(asr_20_29[_n-1]+asr_20_29
> [_n]+asr_20_29[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_30_39_ma =(asr_30_39[_n-1]+asr_30_39
> [_n]+asr_30_39[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_40_49_ma =(asr_40_49[_n-1]+asr_40_49
> [_n]+asr_40_49[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_50_59_ma =(asr_50_59[_n-1]+asr_50_59
> [_n]+asr_50_59[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_60_69_ma =(asr_60_69[_n-1]+asr_60_69
> [_n]+asr_60_69[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_70_79_ma =(asr_70_79[_n-1]+asr_70_79
> [_n]+asr_70_79[_n+1])/3
(588 missing values generated)

. bysort measure (interval_start): gen asr_80_ma =(asr_80[_n-1]+asr_80[_n]+asr_
> 80[_n+1])/3
(588 missing values generated)

. 
. /*gen asr_lci = asr-1.96*(asr/sqrt(denominator_all))
> gen asr_uci = asr+1.96*(asr/sqrt(denominator_all))
> gen asr_esp = Prop*calc_pyr_
> bys year: egen sum_asr_esp=sum(asr_esp)
> gen asir = sum_asr_esp/sum_prop
> gen total_pyr = pyr_ if Age=="all_"
> bys year_cal: ereplace total_pyr = max(total_pyr)
> gen ci_95 = (calc_pyr_*Prop*Prop*100000/pyr_)
> gen sum_ci_95 = sum(ci_95)/(sum_prop*sum_prop)
> gen standerror = sqrt(sum_ci_95)
> gen asir_lci = asir-1.96*standerror
> gen asir_uci = asir+1.96*standerror
> */
. 
. save "$projectdir/output/data/processed_standardised.dta", replace
file /workspace/output/data/processed_standardised.dta saved

. 
. use "$projectdir/output/data/processed_standardised.dta", clear

. 
. levelsof diseases_, local(levels)
`"diabetes_mellitus"' `"multiple_sclerosis"' `"rheumatoid_arthritis"'

. foreach disease_ of local levels {
  2.         di "`disease_'"
  3.         local dis_title = strproper(subinstr("`disease_'", "_", " ",.)) 
  4.         
.         *Unadjusted incidence overall/male/female
.         preserve
  5.         keep if measure_inc==1
  6.         keep if diseases_ == "`disease_'"
  7. 
.         twoway connected ratio_all_100000 mo_year_diagn, ytitle("Monthly inci
> dence per 100,000 population", size(med)) color(gold) msymbol(circle) lstyle(
> solid) lcolor(gold) || connected ratio_male_100000 mo_year_diagn, color(ebblu
> e) msymbol(circle) lstyle(solid) lcolor(ebblue) || connected ratio_female_100
> 000 mo_year_diagn, color(red) lcolor(red) msymbol(circle) lstyle(solid) ylabe
> l(, nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(me
> dsmall)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2
> 020" 734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  tit
> le("`dis_title'", size(medium)) xline(722) legend(region(fcolor(white%0)) ord
> er(1 "All" 2 "Male" 3 "Female")) name(`disease_'_incidence, replace) saving("
> $projectdir/output/figures/`disease_'_incidence.gph", replace)
  8.                 graph export "$projectdir/output/figures/incidence_`diseas
> e_'.svg", replace
  9.         restore         
 10.                 
.         *Unadjusted prevalence overall/male/female
.         preserve
 11.         keep if measure_prev==1
 12.         keep if diseases_ == "`disease_'"
 13. 
.         twoway connected ratio_all_100000 year, ytitle("Prevalence per 100,00
> 0 population", size(med)) color(gold) msymbol(circle) lstyle(solid) lcolor(go
> ld)  || connected ratio_male_100000 year, color(ebblue) msymbol(circle) lstyl
> e(solid) lcolor(ebblue)  || connected ratio_female_100000 year, color(red) lc
> olor(red) msymbol(circle) lstyle(solid) ylabel(, nogrid labsize(small)) xtitl
> e("Year beginning", size(medium) margin(medsmall)) xlabel(, nogrid)  title("`
> dis_title'", size(medium)) xline(2020) legend(region(fcolor(white%0)) order(1
>  "All" 2 "Male" 3 "Female")) name(`disease_'_prevalence, replace) saving("$pr
> ojectdir/output/figures/`disease_'_prevalence.gph", replace)
 14.                 graph export "$projectdir/output/figures/prevalence_`disea
> se_'.svg", replace
 15.         restore 
 16.         
.         *Adjusted incidence comparison
.         preserve
 17.         keep if measure_inc==1
 18.         keep if diseases_ == "`disease_'"
 19. 
.         twoway connected ratio_all_100000 mo_year_diagn, ytitle("Monthly inci
> dence per 100,000 population", size(med)) color(gold) msymbol(circle) lstyle(
> solid) lcolor(gold)  || connected asr_all mo_year_diagn, color(green) msymbol
> (circle) lstyle(solid) lcolor(green) ylabel(, nogrid labsize(small)) xtitle("
> Date of diagnosis", size(medium) margin(medsmall)) xlabel(662 "2015" 674 "201
> 6" 686 "2017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 758 "202
> 3" 770 "2024", nogrid labsize(small))  title("`dis_title'", size(medium)) leg
> end(region(fcolor(white%0)) order(1 "Crude" 2 "Adjusted")) name(`disease_'_in
> c_comp, replace) saving("$projectdir/output/figures/`disease_'_inc_comp.gph",
>  replace)
 20.                 graph export "$projectdir/output/figures/inc_comp_`disease
> _'.svg", replace
 21.         restore         
 22.                         
.         *Adjusted prevalence comparison
.         preserve
 23.         keep if measure_prev==1
 24.         keep if diseases_ == "`disease_'"
 25. 
.         twoway connected ratio_all_100000 year, ytitle("Prevalence per 100,00
> 0 population", size(med)) color(gold) msymbol(circle) lstyle(solid) lcolor(go
> ld) || connected asr_all year, color(green) msymbol(circle) lstyle(solid) lco
> lor(green) ylabel(, nogrid labsize(small)) xtitle("Year beginning", size(medi
> um) margin(medsmall)) xlabel(, nogrid)  title("`dis_title'", size(medium)) le
> gend(region(fcolor(white%0)) order(1 "Crude" 2 "Adjusted")) name(`disease_'_p
> rev_comp, replace) saving("$projectdir/output/figures/`disease_'_prev_comp.gp
> h", replace)
 26.                 graph export "$projectdir/output/figures/prev_comp_`diseas
> e_'.svg", replace
 27.         restore         
 28.         
.         *Adjusted incidence overall/male/female
.         preserve
 29.         keep if measure_inc==1
 30.         keep if diseases_ == "`disease_'"
 31. 
.         twoway connected asr_all mo_year_diagn, ytitle("Monthly incidence per
>  100,000 population", size(med)) color(gold) msymbol(circle) lstyle(solid) lc
> olor(gold) || connected asr_male mo_year_diagn, color(ebblue) msymbol(circle)
>  lstyle(solid) lcolor(ebblue) || connected asr_female mo_year_diagn, color(re
> d) msymbol(circle) lstyle(solid) lcolor(red)  ylabel(, nogrid labsize(small))
>  xtitle("Date of diagnosis", size(medium) margin(medsmall)) xlabel(662 "2015"
>  674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022"
>  758 "2023" 770 "2024", nogrid labsize(small))  title("`dis_title'", size(med
> ium)) xline(722) legend(region(fcolor(white%0)) order(1 "All" 2 "Male" 3 "Fem
> ale")) name(`disease_'_inc_adj, replace) saving("$projectdir/output/figures/`
> disease_'_inc_adj.gph", replace)
 32.                 graph export "$projectdir/output/figures/inc_adj_`disease_
> '.svg", replace
 33.         restore 
 34.         
.         *Adjusted incidence moving average overall/male/female
.         preserve
 35.         keep if measure_inc==1
 36.         keep if diseases_ == "`disease_'"
 37. 
.         twoway line asr_all_ma mo_year_diagn, ytitle("Monthly incidence per 1
> 00,000 population", size(med)) lcolor(gold) lstyle(solid) || scatter asr_all 
> mo_year_diagn, color(gold) msymbol(circle) || line asr_male_ma mo_year_diagn,
>  lcolor(ebblue) lstyle(solid) || scatter asr_male mo_year_diagn, color(ebblue
> ) msymbol(circle) || line asr_female_ma mo_year_diagn, lcolor(red) lstyle(sol
> id) || scatter asr_female mo_year_diagn, color(red) msymbol(circle) ylabel(, 
> nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(medsma
> ll)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020"
>  734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  title("
> `dis_title'", size(medium)) xline(722) legend(region(fcolor(white%0)) order(2
>  "All" 4 "Male" 6 "Female")) name(`disease_'_inc_ma_sex, replace) saving("$pr
> ojectdir/output/figures/`disease_'_inc_ma_sex.gph", replace)
 38.                 graph export "$projectdir/output/figures/inc_ma_sex_`disea
> se_'.svg", replace
 39.         restore         
 40.                 
.         *Adjusted prevalence overall/male/female
.         preserve
 41.         keep if measure_prev==1
 42.         keep if diseases_ == "`disease_'"
 43. 
.         twoway connected asr_all year, ytitle("Prevalence per 100,000 populat
> ion", size(med)) color(gold) msymbol(circle) lcolor(gold) lstyle(solid) || co
> nnected asr_male year, color(ebblue) msymbol(circle) lcolor(ebblue) lstyle(so
> lid) || connected asr_female year, color(red) msymbol(circle) lcolor(red) lst
> yle(solid) ylabel(, nogrid labsize(small)) xtitle("Year beginning", size(medi
> um) margin(medsmall)) xlabel(, nogrid)  title("`dis_title'", size(medium)) xl
> ine(2020) legend(region(fcolor(white%0)) order(1 "All" 2 "Male" 3 "Female")) 
> name(`disease_'_prev_adj, replace) saving("$projectdir/output/figures/`diseas
> e_'_prev_adj.gph", replace)
 44.                 graph export "$projectdir/output/figures/prev_adj_`disease
> _'.svg", replace
 45.         restore 
 46. */      
.         *Adjusted incidence overall with moving average (connected)
.         preserve
 47.         keep if measure_inc==1
 48.         keep if diseases_ == "`disease_'"
 49. 
.         twoway connected asr_all mo_year_diagn, ytitle("Monthly incidence per
>  100,000 population", size(med)) color(eltblue) lcolor(bluishgray) msymbol(ci
> rcle) || line asr_all_ma mo_year_diagn, lcolor(midblue) lstyle(solid) ylabel(
> , nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(meds
> mall)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "202
> 0" 734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  title
> ("`dis_title'", size(medium)) xline(722) legend(off) name(`disease_'_inc_adj_
> ma, replace) saving("$projectdir/output/figures/`disease_'_inc_adj_ma.gph", r
> eplace)
 50.                 graph export "$projectdir/output/figures/inc_adj_ma_`disea
> se_'.svg", replace
 51.         restore 
 52.         
.         *Adjusted incidence overall with moving average (scatter)
.         preserve
 53.         keep if measure_inc==1
 54.         keep if diseases_ == "`disease_'"
 55. 
.         twoway scatter asr_all mo_year_diagn, ytitle("Monthly incidence per 1
> 00,000 population", size(med)) color(eltblue) msymbol(circle) || line asr_all
> _ma mo_year_diagn, lcolor(midblue) lstyle(solid) ylabel(, nogrid labsize(smal
> l)) xtitle("Date of diagnosis", size(medium) margin(medsmall)) xlabel(662 "20
> 15" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "20
> 22" 758 "2023" 770 "2024", nogrid labsize(small))  title("`dis_title'", size(
> medium)) xline(722) legend(off) name(`disease_'_inc_adj_ma2, replace) saving(
> "$projectdir/output/figures/`disease_'_inc_adj_ma2.gph", replace)
 56.                 graph export "$projectdir/output/figures/inc_adj_ma2_`dise
> ase_'.svg", replace
 57.         restore 
 58.         
.         *Adjusted incidence overall with moving average, by sex (connected)
.         preserve
 59.         keep if measure_inc==1
 60.         keep if diseases_ == "`disease_'"
 61. 
.         twoway connected asr_male mo_year_diagn, ytitle("Monthly incidence pe
> r 100,000 population", size(med)) color(eltblue) lstyle(solid) lcolor(bluishg
> ray) msymbol(circle) || line asr_male_ma mo_year_diagn, lcolor(midblue) lstyl
> e(solid) || connected asr_female mo_year_diagn, color(orange) lstyle(solid) l
> color(orange%50) msymbol(circle)  || line asr_female_ma mo_year_diagn, lcolor
> (red) lstyle(solid) ylabel(, nogrid labsize(small)) xtitle("Date of diagnosis
> ", size(medium) margin(medsmall)) xlabel(662 "2015" 674 "2016" 686 "2017" 698
>  "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 758 "2023" 770 "2024", no
> grid labsize(small))  title("`dis_title'", size(medium)) xline(722) legend(re
> gion(fcolor(white%0)) order(1 "Male" 3 "Female")) name(`disease_'_adj_ma_sex,
>  replace) saving("$projectdir/output/figures/`disease_'_adj_ma_sex.gph", repl
> ace)
 62.                 graph export "$projectdir/output/figures/adj_ma_sex_`disea
> se_'.svg", replace
 63.         restore         
 64.         
.         *Adjusted incidence overall with moving average, by sex (scatter)
.         preserve
 65.         keep if measure_inc==1
 66.         keep if diseases_ == "`disease_'"
 67. 
.         twoway scatter asr_male mo_year_diagn, ytitle("Monthly incidence per 
> 100,000 population", size(med)) color(eltblue) msymbol(circle) || line asr_ma
> le_ma mo_year_diagn, lcolor(midblue) lstyle(solid) || scatter asr_female mo_y
> ear_diagn, color(orange) msymbol(circle)  || line asr_female_ma mo_year_diagn
> , lcolor(red) lstyle(solid) ylabel(, nogrid labsize(small)) xtitle("Date of d
> iagnosis", size(medium) margin(medsmall)) xlabel(662 "2015" 674 "2016" 686 "2
> 017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 758 "2023" 770 "2
> 024", nogrid labsize(small))  title("`dis_title'", size(medium)) xline(722) l
> egend(region(fcolor(white%0)) order(1 "Male" 3 "Female")) name(`disease_'_adj
> _ma_sex2, replace) saving("$projectdir/output/figures/`disease_'_adj_ma_sex2.
> gph", replace)
 68.                 graph export "$projectdir/output/figures/adj_ma_sex2_`dise
> ase_'.svg", replace
 69.         restore         
 70.         
.         *Adjusted incidence overall with moving average, by age group (scatte
> r)
.         preserve
 71.         keep if measure_inc==1
 72.         keep if diseases_ == "`disease_'"
 73. 
.         twoway scatter asr_0_9 mo_year_diagn, ytitle("Monthly incidence per 1
> 00,000 population", size(med)) color(yellow) msymbol(circle) || line asr_0_9_
> ma mo_year_diagn, lcolor(yellow) lstyle(solid) || scatter asr_10_19 mo_year_d
> iagn, ytitle("Monthly incidence per 100,000 population", size(med)) color(ora
> nge) msymbol(circle) || line asr_10_19_ma mo_year_diagn, lcolor(orange) lstyl
> e(solid) || scatter asr_20_29 mo_year_diagn, ytitle("Monthly incidence per 10
> 0,000 population", size(med)) color(red) msymbol(circle) || line asr_20_29_ma
>  mo_year_diagn, lcolor(red) lstyle(solid) || scatter asr_30_39 mo_year_diagn,
>  ytitle("Monthly incidence per 100,000 population", size(med)) color(ltblue) 
> msymbol(circle) || line asr_30_39_ma mo_year_diagn, lcolor(ltblue) lstyle(sol
> id) || scatter asr_40_49 mo_year_diagn, ytitle("Monthly incidence per 100,000
>  population", size(med)) color(eltblue) msymbol(circle) || line asr_40_49_ma 
> mo_year_diagn, lcolor(eltblue) lstyle(solid) || scatter asr_50_59 mo_year_dia
> gn, ytitle("Monthly incidence per 100,000 population", size(med)) color(blue)
>  msymbol(circle) || line asr_50_59_ma mo_year_diagn, lcolor(blue) lstyle(soli
> d) || scatter asr_60_69 mo_year_diagn, ytitle("Monthly incidence per 100,000 
> population", size(med)) color(purple) msymbol(circle) || line asr_60_69_ma mo
> _year_diagn, lcolor(purple) lstyle(solid) || scatter asr_70_79 mo_year_diagn,
>  ytitle("Monthly incidence per 100,000 population", size(med)) color(brown) m
> symbol(circle) || line asr_70_79_ma mo_year_diagn, lcolor(brown) lstyle(solid
> ) || scatter asr_80 mo_year_diagn, ytitle("Monthly incidence per 100,000 popu
> lation", size(med)) color(black) msymbol(circle) || line asr_80_ma mo_year_di
> agn, lcolor(black) lstyle(solid) ylabel(, nogrid labsize(small)) xtitle("Date
>  of diagnosis", size(medium) margin(medsmall)) xlabel(662 "2015" 674 "2016" 6
> 86 "2017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 758 "2023" 7
> 70 "2024", nogrid labsize(small))  title("`dis_title'", size(medium)) xline(7
> 22) legend(region(fcolor(white%0)) order(1 "0-9" 3 "10-19" 5 "20-29" 7 "30-39
> " 9 "40-49" 11 "50-59" 13 "60-69" 15 "70-79" 19 "80+")) name(`disease_'_adj_m
> a_age, replace) saving("$projectdir/output/figures/`disease_'_adj_ma_age.gph"
> , replace)
 74.                 graph export "$projectdir/output/figures/adj_ma_age_`disea
> se_'.svg", replace
 75.         restore 
 76.         
. *******Also need by IMD quintile +/- ethnicity**************    
.                 
. /*      
>         *Adjusted incidence overall, with 95% CI
>         preserve
>         keep if measure_inc==1
>         keep if diseases_ == "`disease_'"
> 
>         twoway connected ratio_all_100 mo_year_diagn, ytitle("Monthly inciden
> ce per 100 population", size(med)) color(gold) || (connected asr mo_year_diag
> n, color(green)) (rcap asr_lci asr_uci mo_year_diagn, color(green)) ylabel(, 
>  nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(medsm
> all)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020
> " 734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  title(
> "`dis_title'", size(medium)) legend(region(fcolor(white%0)) order(1 "Unadjust
> ed" 2 "Adjusted")) name(`disease_'_incidence_as_95, replace) saving("$project
> dir/output/figures/`disease_'_incidence_as_95.gph", replace)
>                 graph export "$projectdir/output/figures/`disease_'_incidence
> _as_95.svg", replace
>         restore         
>                         
>         *Adjusted prevalence overall, with 95% CI
>         preserve
>         keep if measure_prev==1
>         keep if diseases_ == "`disease_'"
> 
>         twoway connected ratio_all_100 year, ytitle("Prevalence (%)", size(me
> d)) color(gold) || connected asr year, color(green) ylabel(, nogrid labsize(s
> mall)) xtitle("Year beginning", size(medium) margin(medsmall)) xlabel(, nogri
> d)  title("`dis_title'", size(medium)) legend(region(fcolor(white%0)) order(1
>  "Unadjusted" 2 "Adjusted")) name(`disease_'_prevalence_as_95, replace) savin
> g("$projectdir/output/figures/`disease_'_prevalence_as_95.gph", replace)
>                 graph export "$projectdir/output/figures/`disease_'_prevalenc
> e_as_95.svg", replace
>         restore 
>         */
. }
diabetes_mellitus
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_incidence.gph saved)
(note: file /workspace/output/figures/incidence_diabetes_mellitus.svg not found
> )
(file /workspace/output/figures/incidence_diabetes_mellitus.svg written in SVG 
> format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_prevalence.gph saved)
(note: file /workspace/output/figures/prevalence_diabetes_mellitus.svg not foun
> d)
(file /workspace/output/figures/prevalence_diabetes_mellitus.svg written in SVG
>  format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_inc_comp.gph saved)
(note: file /workspace/output/figures/inc_comp_diabetes_mellitus.svg not found)
(file /workspace/output/figures/inc_comp_diabetes_mellitus.svg written in SVG f
> ormat)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_prev_comp.gph saved)
(note: file /workspace/output/figures/prev_comp_diabetes_mellitus.svg not found
> )
(file /workspace/output/figures/prev_comp_diabetes_mellitus.svg written in SVG 
> format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_inc_adj.gph saved)
(note: file /workspace/output/figures/inc_adj_diabetes_mellitus.svg not found)
(file /workspace/output/figures/inc_adj_diabetes_mellitus.svg written in SVG fo
> rmat)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_inc_ma_sex.gph saved)
(note: file /workspace/output/figures/inc_ma_sex_diabetes_mellitus.svg not foun
> d)
(file /workspace/output/figures/inc_ma_sex_diabetes_mellitus.svg written in SVG
>  format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_prev_adj.gph saved)
(note: file /workspace/output/figures/prev_adj_diabetes_mellitus.svg not found)
(file /workspace/output/figures/prev_adj_diabetes_mellitus.svg written in SVG f
> ormat)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_inc_adj_ma.gph saved)
(note: file /workspace/output/figures/inc_adj_ma_diabetes_mellitus.svg not foun
> d)
(file /workspace/output/figures/inc_adj_ma_diabetes_mellitus.svg written in SVG
>  format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_inc_adj_ma2.gph saved)
(note: file /workspace/output/figures/inc_adj_ma2_diabetes_mellitus.svg not fou
> nd)
(file /workspace/output/figures/inc_adj_ma2_diabetes_mellitus.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_adj_ma_sex.gph saved)
(note: file /workspace/output/figures/adj_ma_sex_diabetes_mellitus.svg not foun
> d)
(file /workspace/output/figures/adj_ma_sex_diabetes_mellitus.svg written in SVG
>  format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_adj_ma_sex2.gph saved)
(note: file /workspace/output/figures/adj_ma_sex2_diabetes_mellitus.svg not fou
> nd)
(file /workspace/output/figures/adj_ma_sex2_diabetes_mellitus.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/diabetes_mellitus_adj_ma_age.gph saved)
(note: file /workspace/output/figures/adj_ma_age_diabetes_mellitus.svg not foun
> d)
(file /workspace/output/figures/adj_ma_age_diabetes_mellitus.svg written in SVG
>  format)
multiple_sclerosis
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_incidence.gph saved)
(note: file /workspace/output/figures/incidence_multiple_sclerosis.svg not foun
> d)
(file /workspace/output/figures/incidence_multiple_sclerosis.svg written in SVG
>  format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_prevalence.gph saved)
(note: file /workspace/output/figures/prevalence_multiple_sclerosis.svg not fou
> nd)
(file /workspace/output/figures/prevalence_multiple_sclerosis.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_inc_comp.gph saved)
(note: file /workspace/output/figures/inc_comp_multiple_sclerosis.svg not found
> )
(file /workspace/output/figures/inc_comp_multiple_sclerosis.svg written in SVG 
> format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_prev_comp.gph saved)
(note: file /workspace/output/figures/prev_comp_multiple_sclerosis.svg not foun
> d)
(file /workspace/output/figures/prev_comp_multiple_sclerosis.svg written in SVG
>  format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_inc_adj.gph saved)
(note: file /workspace/output/figures/inc_adj_multiple_sclerosis.svg not found)
(file /workspace/output/figures/inc_adj_multiple_sclerosis.svg written in SVG f
> ormat)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_inc_ma_sex.gph saved)
(note: file /workspace/output/figures/inc_ma_sex_multiple_sclerosis.svg not fou
> nd)
(file /workspace/output/figures/inc_ma_sex_multiple_sclerosis.svg written in SV
> G format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_prev_adj.gph saved)
(note: file /workspace/output/figures/prev_adj_multiple_sclerosis.svg not found
> )
(file /workspace/output/figures/prev_adj_multiple_sclerosis.svg written in SVG 
> format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_inc_adj_ma.gph saved)
(note: file /workspace/output/figures/inc_adj_ma_multiple_sclerosis.svg not fou
> nd)
(file /workspace/output/figures/inc_adj_ma_multiple_sclerosis.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_inc_adj_ma2.gph saved)
(note: file /workspace/output/figures/inc_adj_ma2_multiple_sclerosis.svg not fo
> und)
(file /workspace/output/figures/inc_adj_ma2_multiple_sclerosis.svg written in S
> VG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_adj_ma_sex.gph saved)
(note: file /workspace/output/figures/adj_ma_sex_multiple_sclerosis.svg not fou
> nd)
(file /workspace/output/figures/adj_ma_sex_multiple_sclerosis.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_adj_ma_sex2.gph saved)
(note: file /workspace/output/figures/adj_ma_sex2_multiple_sclerosis.svg not fo
> und)
(file /workspace/output/figures/adj_ma_sex2_multiple_sclerosis.svg written in S
> VG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/multiple_sclerosis_adj_ma_age.gph saved)
(note: file /workspace/output/figures/adj_ma_age_multiple_sclerosis.svg not fou
> nd)
(file /workspace/output/figures/adj_ma_age_multiple_sclerosis.svg written in SV
> G format)
rheumatoid_arthritis
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_incidence.gph saved)
(note: file /workspace/output/figures/incidence_rheumatoid_arthritis.svg not fo
> und)
(file /workspace/output/figures/incidence_rheumatoid_arthritis.svg written in S
> VG format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_prevalence.gph saved)
(note: file /workspace/output/figures/prevalence_rheumatoid_arthritis.svg not f
> ound)
(file /workspace/output/figures/prevalence_rheumatoid_arthritis.svg written in 
> SVG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_inc_comp.gph saved)
(note: file /workspace/output/figures/inc_comp_rheumatoid_arthritis.svg not fou
> nd)
(file /workspace/output/figures/inc_comp_rheumatoid_arthritis.svg written in SV
> G format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_prev_comp.gph saved)
(note: file /workspace/output/figures/prev_comp_rheumatoid_arthritis.svg not fo
> und)
(file /workspace/output/figures/prev_comp_rheumatoid_arthritis.svg written in S
> VG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_inc_adj.gph saved)
(note: file /workspace/output/figures/inc_adj_rheumatoid_arthritis.svg not foun
> d)
(file /workspace/output/figures/inc_adj_rheumatoid_arthritis.svg written in SVG
>  format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_inc_ma_sex.gph saved)
(note: file /workspace/output/figures/inc_ma_sex_rheumatoid_arthritis.svg not f
> ound)
(file /workspace/output/figures/inc_ma_sex_rheumatoid_arthritis.svg written in 
> SVG format)
(864 observations deleted)
(16 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_prev_adj.gph saved)
(note: file /workspace/output/figures/prev_adj_rheumatoid_arthritis.svg not fou
> nd)
(file /workspace/output/figures/prev_adj_rheumatoid_arthritis.svg written in SV
> G format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_inc_adj_ma.gph saved)
(note: file /workspace/output/figures/inc_adj_ma_rheumatoid_arthritis.svg not f
> ound)
(file /workspace/output/figures/inc_adj_ma_rheumatoid_arthritis.svg written in 
> SVG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_inc_adj_ma2.gph saved)
(note: file /workspace/output/figures/inc_adj_ma2_rheumatoid_arthritis.svg not 
> found)
(file /workspace/output/figures/inc_adj_ma2_rheumatoid_arthritis.svg written in
>  SVG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_adj_ma_sex.gph saved)
(note: file /workspace/output/figures/adj_ma_sex_rheumatoid_arthritis.svg not f
> ound)
(file /workspace/output/figures/adj_ma_sex_rheumatoid_arthritis.svg written in 
> SVG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_adj_ma_sex2.gph saved)
(note: file /workspace/output/figures/adj_ma_sex2_rheumatoid_arthritis.svg not 
> found)
(file /workspace/output/figures/adj_ma_sex2_rheumatoid_arthritis.svg written in
>  SVG format)
(600 observations deleted)
(192 observations deleted)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(note:  named style med not found in class gsize, default attributes used)
(file /workspace/output/figures/rheumatoid_arthritis_adj_ma_age.gph saved)
(note: file /workspace/output/figures/adj_ma_age_rheumatoid_arthritis.svg not f
> ound)
(file /workspace/output/figures/adj_ma_age_rheumatoid_arthritis.svg written in 
> SVG format)

. /*      
> keep if measure_inc==1
> keep if measure == "rheumatoid_arthritis_incidence"
> keep if disease == "Rheumatoid Arthritis"
> 
> *Lowess
> twoway scatter asr_all mo_year_diagn, ytitle("Monthly incidence per 100,000 p
> opulation", size(med)) color(gold) || lowess asr_all mo_year_diagn, ylabel(, 
> nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(medsma
> ll)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020"
>  734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  title("
> `dis_title'", size(medium)) xline(722) legend(region(fcolor(white%0)) order(1
>  "All" 2 "Male" 3 "Female")) name(prev_lowess, replace) saving("$projectdir/o
> utput/figures/prev_lowess.gph", replace)
> 
> *Test Lowess with gout data - not good enough
> import delimited "$projectdir/output/data/incidence_month_rounded.csv", clear
> gen monyear = monthly(mo_year_diagn, "MY", 2000) + 1200
> format monyear %tmMon-CCYY
> drop  mo_year_diagn
> rename monyear mo_year_diagn
> 
> keep if sex=="All"
> 
> twoway scatter incidence mo_year_diagn, ytitle("Monthly incidence per 100,000
>  population", size(med)) color(gold) || lowess incidence mo_year_diagn, ylabe
> l(, nogrid labsize(small)) xtitle("Date of diagnosis", size(medium) margin(me
> dsmall)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2
> 020" 734 "2021" 746 "2022" 758 "2023" 770 "2024", nogrid labsize(small))  tit
> le("Gout", size(medium)) xline(722) legend(region(fcolor(white%0)) order(1 "A
> ll" 2 "Male" 3 "Female")) name(prev_lowess, replace) saving("$projectdir/outp
> ut/figures/prev_lowess.gph", replace)
> 
> *Moving average
> use "$projectdir/output/data/processed_standardised.dta", clear
> 
> twoway connected asr_all mo_year_diagn, ytitle("Monthly incidence per 100,000
>  population", size(med)) color(eltblue) lcolor(bluishgray)|| line asr_all_ma 
> mo_year_diagn, lcolor(midblue) lstyle(solid) ylabel(, nogrid labsize(small)) 
> xtitle("Date of diagnosis", size(medium) margin(medsmall)) xlabel(662 "2015" 
> 674 "2016" 686 "2017" 698 "2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 
> 758 "2023" 770 "2024", nogrid labsize(small))  title("Rheumatoid Arthritis", 
> size(medium)) xline(722) legend(off) name(nc_adj_ma, replace) saving("$projec
> tdir/output/figures/inc_adj_ma.gph", replace)
> 
> 
> 
> *ARIMA
> 
> use "$projectdir/output/data/processed_standardised.dta", clear
> 
> keep if measure == "rheumatoid_arthritis_incidence"
> 
> sort mo_year_diagn
> keep mo_year_diagn ratio_all_100000 //use crude incidence rate 
> rename ratio_all_100000 inc_rate
> gen t=_n
> tsset t
> 
> *Plot raw series - is it stationary?
> twoway (tsline inc_rate) //No
> 
> *Now plot differenced asr to see if stationarity  
> gen inc_rate_diff = D.inc_rate
> twoway (tsline inc_rate_diff) //stationary - we will use difference for our m
> odel
> 
> gen inc_rate_diffr = D.inc_rate/L.inc_rate //% difference
> twoway (tsline inc_rate_diffr) //also stationary
> 
> *Now check for seasonality
> gen inc_rate_seasonal = inc_rate_diff - inc_rate_diff[_n-12]
> twoway (tsline inc_rate_seasonal) //Stationary - we will use difference for o
> ur model
> 
> *Plot ACF of differenced series (noting the extent of autocorrelation between
>  time points)
> ac inc_rate 
> ac inc_rate_diff //1st lag negative - add MA term (1 term)
> ac inc_rate_seasonal
> 
> *Plot partial ACF of differenced series
> pac inc_rate 
> pac inc_rate_diff
> pac inc_rate_seasonal
> 
> *Autoarima to fit SARIMA model using undifferenced data, it will identify p/q
>  parameters that optimise AIC
> arimaauto inc_rate //suggests ARIMA(1,0,0) AIC 1084
> predict inc_rate_p
> twoway (tsline inc_rate inc_rate_p)
> 
> *Switch to bulk estimation from Hyndman-Khandakar algorithm
> arimaauto inc_rate, nostepwise //suggests ARIMA(4,0,0) AIC 1057
> predict inc_rate_p2
> twoway (tsline inc_rate inc_rate_p2)
> 
> *Manually define d=1
> arima inc_rate, arima(1,0,0)
> estat ic
> 
> arima inc_rate, arima(1,1,0) //AIC 1040
> predict inc_rate_p3
> twoway (tsline inc_rate inc_rate_p3)
> 
> arima inc_rate, arima(4,1,0) //AIC 1034
> estat ic
> predict inc_rate_p4
> twoway (tsline inc_rate_diff inc_rate_p4)
> 
> *How to manually specify d=1 in arimaauto?
> arimaauto inc_rate, arima(0,1,0) nostepwise //(1,1,2) AIC 1032
> predict inc_rate_p5
> twoway (tsline inc_rate_diff inc_rate_p5)
> 
> *Run using differenced data 
> arimaauto inc_rate_diff // 0,0,1 AIC 1034
> estat ic
> predict inc_rate_diff_p1
> twoway (tsline inc_rate_diff inc_rate_diff_p1) 
> arima inc_rate, arima(0,1,1) //AIC 1034
> predict inc_rate_p6
> twoway (tsline inc_rate_diff_p1 inc_rate_p6) //same as above
> 
> *Run nostepwise with differenced data
> arimaauto inc_rate_diff, nostepwise //(1,0,2) AIC 1032
> predict inc_rate_diff_p2
> twoway (tsline inc_rate_diff inc_rate_diff_p2) 
> 
> *Forward predict
> set obs `=_N+10'
> replace t=_n
> 
> arimaauto inc_rate, nostepwise 
> predict inc_rate_p7, dynamic(60)
> twoway (tsline inc_rate inc_rate_p7)
> 
> arimaauto inc_rate_diff, nostepwise 
> predict inc_rate_diff_p3, dynamic(60)
> twoway (tsline inc_rate_diff_p2 inc_rate_diff_p3) 
> 
> gen original_series = .
> replace original_series = inc_rate[1] in 1
> replace original_series = original_series[_n-1] + inc_rate_diff in 2/L
> 
> gen predicted_series = .
> replace predicted_series = inc_rate[1] in 1
> replace predicted_series = predicted_series[_n-1] + inc_rate_diff_p3 in 2/L
> twoway (tsline inc_rate predicted_series)
> 
> *Try with gout data
> import delimited "$projectdir/output/data/incidence_month_rounded.csv", clear
> 
> keep if sex=="All"
> 
> *Change date format
> numdate monthly mo_year_diagn_clean = mo_year_diagn, pattern(MY) topyear(2050
> )
> format mo_year_diagn_clean %tmMon_CCYY
> drop mo_year_diagn
> rename mo_year_diagn_clean mo_year_diagn
> 
> keep mo_year_diagn incidence_gout year
> rename incidence_gout inc_rate
> gen t=_n
> 
> save "$projectdir/output/data/raw_incidence_gout.dta", replace
> 
> keep if year<2020
> 
> *format mo_year_diagn %tmMon-CCYY
> 
> set obs `=_N+36'
> replace t=_n
> 
> tsset t
> 
> *Plot raw series - is it stationary?
> twoway (tsline inc_rate) //No
> 
> *Now plot differenced asr to see if stationarity  
> gen inc_rate_diff = D.inc_rate
> twoway (tsline inc_rate_diff) //stationary - we will use difference for our m
> odel
> 
> gen inc_rate_diffr = D.inc_rate/L.inc_rate //% difference
> twoway (tsline inc_rate_diffr) //also stationary
> 
> *Now check for seasonality
> gen inc_rate_seasonal = inc_rate_diff - inc_rate_diff[_n-12]
> twoway (tsline inc_rate_seasonal)  //Stationary - we will use difference for 
> our model
> 
> *Plot ACF of differenced series (noting the extent of autocorrelation between
>  time points)
> ac inc_rate 
> ac inc_rate_diff //1st lag negative - add MA term (1 term)
> ac inc_rate_seasonal
> 
> *Plot partial ACF of differenced series
> pac inc_rate 
> pac inc_rate_diff
> pac inc_rate_seasonal
> 
> *Autoarima to fit SARIMA model using undifferenced data, it will identify p/q
>  parameters that optimise AIC
> arimaauto inc_rate //this runs infinitely
> predict inc_rate_p
> twoway (tsline inc_rate inc_rate_p)
> 
> *Switch to bulk estimation from Hyndman-Khandakar algorithm
> arimaauto inc_rate, nostepwise
> predict inc_rate_p2
> twoway (tsline inc_rate inc_rate_p2)
> 
> *Attempt model with best fit from R
> arima inc_rate, arima(2,0,1) sarima(1,1,0,12) trace
> estat ic
> predict inc_rate_pR, dynamic(61) y
> twoway (tsline inc_rate inc_rate_pR)
> predict fvar, mse
> gen inc_rate_pR_lower=inc_rate_pR - 1.96*sqrt(fvar)
> gen inc_rate_pR_upper=inc_rate_pR + 1.96*sqrt(fvar)
> drop fvar
> 
> *Merge with original data
> replace inc_rate_pR = inc_rate if t<61
> keep t inc_rate_pR
> merge 1:1 t using "$projectdir/output/data/raw_incidence_gout.dta", nogen
> 
> *Generate 3-monthly moving averages of IR
> gen inc_rate_ma =(inc_rate[_n-1]+inc_rate[_n]+inc_rate[_n+1])/3
> gen inc_rate_pR_ma =(inc_rate_pR[_n-1]+inc_rate_pR[_n]+inc_rate_pR[_n+1])/3
> 
> *Plot graph of observed and predicted
> twoway connected inc_rate mo_year_diagn, ytitle("Monthly incidence per 100,00
> 0 population", size(med)) color(eltblue) lcolor(bluishgray) msymbol(circle) |
> | line inc_rate_ma mo_year_diagn, lcolor(midblue) lstyle(solid) || connected 
> inc_rate_pR mo_year_diagn if t>60, color(orange%50) lstyle(solid) lcolor(oran
> ge%50) msymbol(circle) || line inc_rate_pR_ma mo_year_diagn if t>60, lcolor(r
> ed) lstyle(solid) ylabel(, nogrid labsize(small)) xtitle("Date of diagnosis",
>  size(medium) margin(medsmall)) xlabel(662 "2015" 674 "2016" 686 "2017" 698 "
> 2018" 710 "2019" 722 "2020" 734 "2021" 746 "2022" 758 "2023" 770 "2024", nogr
> id labsize(small))  title("Gout", size(medium)) xline(722) legend(off) name(g
> out_inc_adj_ma, replace) saving("$projectdir/output/figures/gout_inc_adj_ma.g
> ph", replace)
>         graph export "$projectdir/output/figures/gout_inc_adj_ma.svg", replac
> e          
>         
> *Run using differenced data 
> arimaauto inc_rate_diff, nostepwise 
> predict inc_rate_diff_p1
> twoway (tsline inc_rate_diff inc_rate_diff_p1) 
> predict  inc_rate_diff_p2, dynamic(61)
> twoway (tsline inc_rate_diff inc_rate_diff_p2) 
> 
> arimaauto inc_rate, arima(0,1,0) sarima(0,1,0,12) nostepwise trace
> predict inc_rate_p4
> twoway (tsline inc_rate inc_rate_p4)
> 
> arima inc_rate, arima(0,1,0) 
> predict inc_rate_p5
> 
> set obs `=_N+10'
> replace t=_n
> arima inc_rate, arima(1,0,0)
> predict inc_rate_p6
> twoway (tsline inc_rate inc_rate_p6)
> 
> estat ic
> 
> arima inc_rate, arima(1,1,0) //AIC 1040
> predict inc_rate_p3
> twoway (tsline inc_rate inc_rate_p3)
> 
> arima inc_rate, arima(4,1,0) //AIC 1034
> estat ic
> predict inc_rate_p4
> twoway (tsline inc_rate_diff inc_rate_p4)
> 
> *How to manually specify d=1 in arimaauto?
> arimaauto inc_rate, arima(0,1,0) nostepwise //(1,1,2) AIC 1032
> predict inc_rate_p5
> twoway (tsline inc_rate_diff inc_rate_p5)
> 
> *Run nostepwise with differenced data
> arimaauto inc_rate_diff, nostepwise //(1,0,2) AIC 1032
> predict inc_rate_diff_p2
> twoway (tsline inc_rate_diff inc_rate_diff_p2) 
> 
> arimaauto inc_rate, nostepwise 
> predict inc_rate_p7, dynamic(60)
> twoway (tsline inc_rate inc_rate_p7)
> 
> arimaauto inc_rate_diff, nostepwise 
> predict inc_rate_diff_p3, dynamic(60)
> twoway (tsline inc_rate_diff_p2 inc_rate_diff_p3) 
> 
> gen original_series = .
> replace original_series = inc_rate[1] in 1
> replace original_series = original_series[_n-1] + inc_rate_diff in 2/L
> 
> gen predicted_series = .
> replace predicted_series = inc_rate[1] in 1
> replace predicted_series = predicted_series[_n-1] + inc_rate_diff_p3 in 2/L
> twoway (tsline inc_rate predicted_series)
> 
> gen asr_all_ln = ln(asr_all)
> tsline asr_all //check trends (for D)
> tsline D.asr_all
> tsline D.asr_all_ln //D = 1
> 
> ac D.asr_all_ln //for Q
> ac D.asr_all_ln //Q = 1
> 
> pac D.asr_all_ln //for P (try 4)
> 
> gen asr_diff = D.asr_all/L.asr_all
> tsline asr_diff
> arima asr_diff if t<=50, arima(1,1,1) sarima(1,1,1,12) noconstant
> predict asr_diff_p, dynamic(50)
> tsline asr_diff asr_diff_p
> 
> arima asr_all if t<=50, arima(4,1,1) noconstant
> predict asr_all_p, dynamic(50)
> tsline asr_all asr_all_p
> 
> 
> /*
> 
> *Output tables as CSVs           
> import excel "$projectdir/output/tables/baseline_bydiagnosis.xls", clear
> outsheet * using "$projectdir/output/tables/baseline_bydiagnosis.csv" , comma
>  nonames replace   
> 
> */
> 
> 
> log close

end of do-file

. . file open output using "/tmp/100_incidence_graphs.do.eQfs.out", write text 
> replace

. . file write output "success" 

. . file close output

. 
end of do-file


